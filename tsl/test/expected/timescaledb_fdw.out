-- This file and its contents are licensed under the Timescale License.
-- Please see the included NOTICE for copyright information and
-- LICENSE-TIMESCALE for a copy of the license.
\c :TEST_DBNAME :ROLE_SUPERUSER
ALTER ROLE :ROLE_DEFAULT_CLUSTER_USER CREATEDB PASSWORD 'pass';
GRANT USAGE ON FOREIGN DATA WRAPPER timescaledb_fdw TO :ROLE_DEFAULT_CLUSTER_USER;
SET ROLE :ROLE_DEFAULT_CLUSTER_USER;
-- Cleanup from other potential tests that created this database
SET client_min_messages TO ERROR;
DROP DATABASE IF EXISTS server_1;
SET client_min_messages TO NOTICE;
CREATE DATABASE server_1;
SELECT * FROM add_server('server_1', database => 'server_1', password => 'pass');
 server_name |   host    | port  | database |       username       |   server_username    | created 
-------------+-----------+-------+----------+----------------------+----------------------+---------
 server_1    | localhost | 15432 | server_1 | default_cluster_user | default_cluster_user | t
(1 row)

\c server_1
SET client_min_messages TO ERROR;
CREATE EXTENSION timescaledb;
SET ROLE :ROLE_DEFAULT_CLUSTER_USER;
CREATE TABLE test_ft (c0 int, c1 varchar(10));
\c :TEST_DBNAME :ROLE_SUPERUSER
SET ROLE :ROLE_DEFAULT_CLUSTER_USER;
CREATE FOREIGN TABLE test_ft (c0 int, c1 varchar(10)) SERVER server_1;
SELECT * FROM test_ft;
 c0 |  c1  
----+------
  1 | test
(1 row)

INSERT INTO test_ft VALUES (1, 'test');
UPDATE test_ft SET c1 = 'new_test';
DELETE FROM test_ft WHERE c0 = 1;
EXPLAIN SELECT * FROM test_ft;
                         QUERY PLAN                         
------------------------------------------------------------
 Foreign Scan on test_ft  (cost=0.00..1.00 rows=1 width=42)
(1 row)

EXPLAIN INSERT INTO test_ft VALUES (1, 'test');
                      QUERY PLAN                      
------------------------------------------------------
 Insert on test_ft  (cost=0.00..0.01 rows=1 width=42)
   ->  Result  (cost=0.00..0.01 rows=1 width=42)
(2 rows)

ANALYZE VERBOSE test_ft;
WARNING:  skipping "test_ft" --- cannot analyze this foreign table

-- Copyright (c) 2016-2018  Timescale, Inc. All Rights Reserved.
--
-- This file is licensed under the Timescale License,
-- see LICENSE-TIMESCALE at the top of the tsl directory.
-- Need to be super user to create extension and add servers
\c :TEST_DBNAME :ROLE_SUPERUSER;
GRANT USAGE ON FOREIGN DATA WRAPPER timescaledb_fdw TO :ROLE_DEFAULT_PERM_USER;
SET ROLE :ROLE_DEFAULT_PERM_USER;
-- Add servers using TimescaleDB server management API
SELECT * FROM add_server('server_1');
 server_name |   host    | port |         database          |     username      |  server_username  | created 
-------------+-----------+------+---------------------------+-------------------+-------------------+---------
 server_1    | localhost | 5432 | db_hypertable_distributed | default_perm_user | default_perm_user | t
(1 row)

SELECT * FROM add_server('server_2');
 server_name |   host    | port |         database          |     username      |  server_username  | created 
-------------+-----------+------+---------------------------+-------------------+-------------------+---------
 server_2    | localhost | 5432 | db_hypertable_distributed | default_perm_user | default_perm_user | t
(1 row)

SELECT * FROM add_server('server_3');
 server_name |   host    | port |         database          |     username      |  server_username  | created 
-------------+-----------+------+---------------------------+-------------------+-------------------+---------
 server_3    | localhost | 5432 | db_hypertable_distributed | default_perm_user | default_perm_user | t
(1 row)

-- Create a distributed hypertable
CREATE TABLE disttable(time timestamptz, device int, temp float);
SELECT * FROM create_hypertable('disttable', 'time', replication_factor => 1);
NOTICE:  adding not-null constraint to column "time"
 hypertable_id | schema_name | table_name | created 
---------------+-------------+------------+---------
             1 | public      | disttable  | t
(1 row)

SELECT * FROM _timescaledb_catalog.hypertable_server;
 hypertable_id | server_hypertable_id | server_name 
---------------+----------------------+-------------
             1 |                      | server_1
             1 |                      | server_2
             1 |                      | server_3
(3 rows)

SELECT * FROM _timescaledb_catalog.chunk_server;
 chunk_id | server_chunk_id | server_name 
----------+-----------------+-------------
(0 rows)

INSERT INTO disttable VALUES
       ('2017-01-01 06:01', 1, 1.1),
       ('2017-01-01 08:01', 1, 1.2),
       ('2018-01-01 08:01', 2, 1.3),
       ('2019-01-01 09:11', 3, 2.1),
       ('2017-01-01 06:05', 1, 1.4);
INFO:  executing function timescaledb_fdw_handler
INFO:  executing function plan_foreign_modify
INFO:  executing function timescaledb_fdw_handler
INFO:  executing function is_foreign_rel_updatable
INFO:  executing function exec_foreign_insert
INFO:  executing function exec_foreign_insert
INFO:  executing function timescaledb_fdw_handler
INFO:  executing function is_foreign_rel_updatable
INFO:  executing function exec_foreign_insert
INFO:  executing function timescaledb_fdw_handler
INFO:  executing function is_foreign_rel_updatable
INFO:  executing function exec_foreign_insert
INFO:  executing function exec_foreign_insert
SELECT * FROM _timescaledb_catalog.chunk_server;
 chunk_id | server_chunk_id | server_name 
----------+-----------------+-------------
        1 |               1 | server_1
        2 |               2 | server_2
        3 |               3 | server_3
(3 rows)

SELECT (_timescaledb_internal.show_chunk(show_chunks)).*
FROM show_chunks('disttable');
 chunk_id | hypertable_id |      schema_name      |      table_name       | relkind |                     slices                     
----------+---------------+-----------------------+-----------------------+---------+------------------------------------------------
        1 |             1 | _timescaledb_internal | _hyper_1_1_dist_chunk | f       | {"time": [1482969600000000, 1483574400000000]}
        2 |             1 | _timescaledb_internal | _hyper_1_2_dist_chunk | f       | {"time": [1514419200000000, 1515024000000000]}
        3 |             1 | _timescaledb_internal | _hyper_1_3_dist_chunk | f       | {"time": [1545868800000000, 1546473600000000]}
(3 rows)

-- Show underreplicated chunk warning
CREATE TABLE underreplicated(time timestamptz, device int, temp float);
SELECT * FROM create_hypertable('underreplicated', 'time', replication_factor => 4);
NOTICE:  adding not-null constraint to column "time"
 hypertable_id | schema_name |   table_name    | created 
---------------+-------------+-----------------+---------
             2 | public      | underreplicated | t
(1 row)

INSERT INTO underreplicated VALUES ('2017-01-01 06:01', 1, 1.1);
INFO:  executing function timescaledb_fdw_handler
INFO:  executing function plan_foreign_modify
WARNING:  under-replicated chunk 4, lacks 1 server(s)
INFO:  executing function timescaledb_fdw_handler
INFO:  executing function is_foreign_rel_updatable
INFO:  executing function exec_foreign_insert
SELECT * FROM _timescaledb_catalog.chunk_server;
 chunk_id | server_chunk_id | server_name 
----------+-----------------+-------------
        1 |               1 | server_1
        2 |               2 | server_2
        3 |               3 | server_3
        4 |               4 | server_1
        4 |               4 | server_2
        4 |               4 | server_3
(6 rows)

SELECT (_timescaledb_internal.show_chunk(show_chunks)).*
FROM show_chunks('underreplicated');
 chunk_id | hypertable_id |      schema_name      |      table_name       | relkind |                     slices                     
----------+---------------+-----------------------+-----------------------+---------+------------------------------------------------
        4 |             2 | _timescaledb_internal | _hyper_2_4_dist_chunk | f       | {"time": [1482969600000000, 1483574400000000]}
(1 row)

